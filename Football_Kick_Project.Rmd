---
title: "Football Kick Project"
output: html_document
date: "2023-07-14"
---

# Setting up libraries
```{r}
library(zoo)
library(pracma)
library(signal)
library(tidyverse)
library(gsignal)
library(readxl)
library(patchwork)
library(magrittr)
```

# EMG processing

## Setup plotting and load data
```{r}
data_mvc_bf <- read_excel("R_BFMVC.xlsx") |>
  rename(time = `X [s]`, signal = `R BICEPS FEMORIS: EMG 2 [V]`)
data_mvc_rf <- read_excel("R_RFMVC.xlsx") |>
  rename(time = `X [s]`, signal = `R RECTUS FEMORIS: EMG 1 [V]`)
data_mvt <- read_excel("EMG_MOVEMENT.xlsx") |>
   rename(time = `X [s]`,
          signal_rf = `R RECTUS FEMORIS: EMG 1 [V]`,
          signal_bf = `R BICEPS FEMORIS: EMG 2 [V]`
    )
```



## Raw EMG signals
```{r}
gg_mvc_bf <- ggplot(data_mvc_bf, aes(time, signal)) +
  geom_line(color = "blue") +
  labs(x = "Time", 
       y = "Amplitude (mV)", 
       title = "EMG MVC Biceps Femoris") +
  theme_light()

gg_mvc_rf <- ggplot(data_mvc_rf, aes(time, signal)) +
  geom_line(color = "blue") +
  labs(x = "Time", 
       y = "Amplitude (mV)", 
       title = "EMG MVC Rectus Femoris") +
  theme_light()

gg_mvt_bf <- ggplot(data_mvt, aes(time, signal_bf)) +
  geom_line(color = "blue") +
  labs(x = "Time", 
       y = "Amplitude (mV)", 
       title = "EMG Movement Biceps Femoris") +
  theme_light()

gg_mvt_rf <- ggplot(data_mvt, aes(time, signal_rf)) +
  geom_line(color = "blue") +
  labs(x = "Time", 
       y = "Amplitude (mV)", 
       title = "EMG Movement Rectus Femoris") +
  theme_light()

gg_mvc_bf / gg_mvc_rf
gg_mvt_bf / gg_mvt_bf

```

## Filter EMG data
```{r}
fs <- 2160
lowcut <- 20
highcut <- 450
order <- 4

# Design a butterworth filter
bf <- butter(order, c(lowcut, highcut)/(fs/2), type= "pass", plane ="z")

# Apply the filter to the data
data_mvc_rf <- data_mvc_rf |> mutate(signal_filtered = filtilt(bf, signal))
data_mvc_bf <- data_mvc_bf |> mutate(signal_filtered = filtilt(bf, signal))
data_mvt <- data_mvt |> mutate(signal_bf_filtered = filtilt(bf, signal_bf), 
                               signal_rf_filtered = filtfilt(bf, signal_rf
                                                            ))
```

# Plot filtered signals

```{r}
plot(timeMVCBF,filteredMVCBF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG MVC Biceps Femoris filtered")

plot(timeMVCRF,filteredMVCRF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG MVC Rectus Femoris filtered")

plot(timeMOVEMENT,filteredMoveBF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Biceps Femoris filtered")

plot(timeMOVEMENT,filteredMoveRF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Rectus Femoris filtered")
```

# 3. Amplitude analysis ( Análisis de la amplitud) 


# 3.2 Envelope (Curva envolvente)

#Rectify

rectifiedMVCBF <- abs(filteredMVCBF)
rectifiedMVCRF <- abs(filteredMVCRF)
rectifiedMOVEBF <- abs(filteredMoveBF)
rectifiedMOVERF <- abs(filteredMoveRF)


plot(timeMVCBF,rectifiedMVCBF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG MVC Biceps Femoris rectified")

plot(timeMVCRF,rectifiedMVCRF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG MVC Rectus Femoris rectified")

plot(timeMOVEMENT,rectifiedMOVEBF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Biceps Femoris rectified")

plot(timeMOVEMENT,rectifiedMOVERF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Rectus Femoris rectified")

# Compute the power of the signal( Cálculo de la potencia de la señal, suavizado)

data_powerMVCBF <- filteredMVCBF^2
data_powerMVCRF <- filteredMVCRF^2
data_powerMoveBF <- filteredMoveBF^2
data_powerMoveRF <- filteredMoveRF^2

# Apply a moving window average to smooth the signal ( Aplicar una media de ventana móvil para suavizar la señal  )

window_size <- 0.1
window_size_samples <- window_size*fs
data_power_smoothedMVCBF <- stats::filter(data_powerMVCBF,rep(1/window_size_samples, window_size_samples), method = "conv")
data_power_smoothedMVCRF <- stats::filter(data_powerMVCRF,rep(1/window_size_samples, window_size_samples), method = "conv")
data_power_smoothedMoveBF <- stats::filter(data_powerMoveBF,rep(1/window_size_samples, window_size_samples), method = "conv")
data_power_smoothedMoveRF <- stats::filter(data_powerMoveRF,rep(1/window_size_samples, window_size_samples), method = "conv")



# Compute the square root of the averaged signal to obtain the RMS envelope ( Calcula la raíz cuadrada de la señal promediada para obtener la envolvente RMS )

data_rms_envMVCBF <- sqrt(data_power_smoothedMVCBF)
data_rms_envMVCRF <- sqrt(data_power_smoothedMVCRF)
data_rms_envMOVEBF <- sqrt(data_power_smoothedMoveBF)
data_rms_envMOVERF <- sqrt(data_power_smoothedMoveRF)

#crear un vector con na

non_naMVCBF <- !is.na(data_rms_envMVCBF)
non_naMVCRF <- !is.na(data_rms_envMVCRF)
non_naMoveBF <- !is.na(data_rms_envMOVEBF)
non_naMoveRF <- !is.na(data_rms_envMOVERF)

#subgrupo con el vector logico

data_rms_envMVCBF <- data_rms_envMVCBF[non_naMVCBF]
data_rms_envMVCRF <- data_rms_envMVCRF[non_naMVCRF]
data_rms_envMOVEBF <- data_rms_envMOVEBF[non_naMoveBF]
data_rms_envMOVERF <- data_rms_envMOVERF[non_naMoveRF]

# Plot the results ( Gráfica de resuktados) 

time_rmsMVCBF <- 1:length(data_rms_envMVCBF)/fs   # time definition (deficion del tiempo) 
time_rmsMVCRF <- 1:length(data_rms_envMVCRF)/fs
time_rmsMOVE <- 1:length(data_rms_envMOVEBF)/fs

plot(time_rmsMVCBF,data_rms_envMVCBF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG MVC Biceps Femoris Smoothed")

plot(time_rmsMVCRF,data_rms_envMVCRF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG MVC Rectus Femoris Smoothed")

plot(time_rmsMOVE,data_rms_envMOVEBF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Biceps Femoris Smoothed")

plot(time_rmsMOVE,data_rms_envMOVERF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Rectus Femoris Smoothed")


# 3.1 Normalization (Normalización)

# Normalize the signal by dividing by the maximum value (Normalizar la señal dividiéndola por el valor máximo)

max_MVCBF <- max(data_rms_envMVCBF)
max_MVCRF <- max(data_rms_envMVCRF)
max_MoveRF <- max(data_rms_envMOVERF)

normalized_dataMoveBF <- data_rms_envMOVEBF/max_MVCBF
normalized_dataMoveRF <- data_rms_envMOVERF/max_MoveRF


# Plot the original and normalized signals (# graficado  las señales filtrada  y normalizada )


par(mfrow=c(2,1))

plot(time_rmsMOVE,data_rms_envMOVEBF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Biceps Femoris Smoothed")

plot(time_rmsMOVE,normalized_dataMoveBF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Biceps Femoris Normalizada")

plot(time_rmsMOVE,data_rms_envMOVERF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Rectus Femoris Smoothed")

plot(time_rmsMOVE,normalized_dataMoveRF, type= "l", xlab="Tiempo(s)", ylab="Amplitud(mV)")
title("EMG Movement Rectus Femoris Normalizada")
```